<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CODE-EASY: Int√©rprete de Pseudoc√≥digo</title>
    <!-- Carga de Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Carga de Ace Editor (N√∫cleo) y el m√≥dulo de Autocompletaci√≥n -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>

    <style>
        /* Fuente principal y estilos base */
        body { font-family: 'Inter', sans-serif; }
        .console {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Contenedor del Editor de Ace. ALTURA FIJA ES NECESARIA para Ace */
        #editor-container {
            width: 100%;
            height: 400px; /* Altura del editor */
            font-size: 14px;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
        }
        
        .ace_editor {
            border-radius: 0.5rem;
            background-color: #2D2D2D !important; /* Asegurar un fondo oscuro consistente */
        }
        
        /* --- ESTILOS CR√çTICOS PARA DESACTIVAR RESALTADO DE L√çNEA Y FORZAR SINTAXIS (v3.8) --- */
        
        /* 1. DESACTIVAR el RESALTADO DE FONDO de la L√çNEA ACTIVA (¬°Soluci√≥n al problema!) */
        #editor-container .ace_active-line {
            background: transparent !important; 
        }
        
        /* 2. PREVENIR que el TEXTO se ponga negro al seleccionar la l√≠nea */
        #editor-container .ace_active-line *,
        #editor-container .ace_active-line .ace_text-layer {
            background-color: transparent !important;
            color: inherit !important; 
        }
        
        /* 3. BASE TEXTO Y VARIABLES (Identificadores): FUERZA BLANCO ULTRA-NEGRILLA */
        #editor-container .ace_text-layer,
        #editor-container .ace_text-layer .ace_line,
        .ace_identifier,
        .ace_variable { 
            color: #FFFFFF !important; /* BLANCO */
            font-weight: 900 !important; /* Ultra Bold */
        }
        
        /* 4. COMANDOS ESTRUCTURALES Y E/S (Keywords): FUERZA AZUL VIVO */
        { token: "ace_keyword ace_operator", regex: "<-|[<>!=\\+\\-\\*\\/]|\\b(Y|O|NO)\\b" },
                        
        .ace_keyword, 
        .ace_storage,
        .ace_keyword.ace_definition,      
        .ace_keyword.ace_control,         
        .ace_keyword.ace_operator, 
        .ace_storage.ace_type.ace_io {       
            color: #3B82F6 !important; /* AZUL VIVO (Tailwind blue-500) */
            font-weight: 900 !important; /* Ultra Negrita */
        }

        /* 5. COMENTARIOS: FUERZA VERDE ESMERALDA VIVO */
        .ace_comment {
            color: #10B981 !important; /* VERDE ESMERALDA VIVO (Tailwind emerald-500) */
            font-weight: 700 !important; /* Negrita */
            font-style: normal !important; 
        }
        
        /* 6. TIPOS DE DATOS (Entero, Real, etc.): FUERZA AMARILLO/√ÅMBAR VIVO */
        .ace_support.ace_type {
            color: #FBBF24 !important; /* AMARILLO/√ÅMBAR VIVO (Tailwind amber-400) */
            font-weight: 800 !important;
        }
        
        /* 7. CADENAS DE TEXTO (Strings): FUERZA CYAN BRILLANTE */
        .ace_string {
            color: #00BCD4 !important; /* CYAN BRILLANTE */
            font-weight: 800 !important; 
        }
        
        /* 8. N√öMEROS Y CONSTANTES (Verdadero/Falso): FUERZA NARANJA VIVO */
        .ace_numeric, .ace_constant.ace_language {
            color: #F97316 !important; /* NARANJA VIVO (Tailwind orange-600) */
            font-weight: 800 !important;
        }
        
        /* Estilo de selecci√≥n (arrastrar el rat√≥n) */
        .ace_selection {
            background: rgba(59, 130, 246, 0.4) !important; /* Azul claro semi-transparente */
        }
        
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <!-- T√çTULO PERSONALIZADO -->
        <h1 class="text-4xl font-extrabold text-teal-700 mb-1">
            CODE-EASY
        </h1>
        <p class="text-lg font-semibold text-gray-500 mb-6 border-b pb-2">
            Int√©rprete de Pseudoc√≥digo - Hecho por Jorge Alberto Pardi√±as Garc√≠a
        </p>
        <!-- FIN DEL T√çTULO PERSONALIZADO -->

        <!-- Alerta de API Key Faltante (Solo visible si API_KEY est√° vac√≠o) -->
        <div id="api-key-warning" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
            <strong class="font-bold">¬°Atenci√≥n! Falta la API Key.</strong>
            <span class="block sm:inline">Para ejecutar el pseudoc√≥digo, **DEBES** obtener y pegar tu clave de API de Gemini en el c√≥digo fuente (ver secci√≥n de scripts).</span>
            <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="text-red-500 underline font-semibold ml-2 hover:text-red-900 transition">Obtener Clave Aqu√≠</a>
        </div>


        <!-- Contenedor principal: Editor a la izquierda, Consola/Variables a la derecha (en desktop) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Columna del Editor de C√≥digo -->
            <div class="lg:col-span-2 space-y-4">

                <!-- Gesti√≥n de Archivos (Guardar/Cargar/Descargar) -->
                <div class="bg-white p-4 rounded-lg shadow-xl border border-gray-200">
                    <h2 class="text-lg font-semibold mb-3 text-teal-700 border-b pb-2">Gesti√≥n de Archivos</h2>
                    <div class="flex items-center space-x-3 mb-4">
                        <label for="document-title" class="text-sm font-medium text-gray-700 whitespace-nowrap">Nombre del Archivo:</label>
                        <input type="text" id="document-title" value="mi_ejercicio_1" class="flex-grow p-2 border border-gray-300 rounded-lg text-sm font-mono" placeholder="Nombre para guardar o cargar el pseudoc√≥digo">
                    </div>
                    <div class="flex space-x-4">
                        <button id="save-button" class="flex-grow px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 disabled:bg-green-300" disabled>
                            üíæ Guardar C√≥digo
                        </button>
                        <button id="load-button" class="flex-grow px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 disabled:bg-blue-300" disabled>
                            üìÇ Cargar C√≥digo
                        </button>
                        <!-- NUEVO BOT√ìN DE DESCARGA -->
                        <button id="download-button" class="flex-grow px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-150">
                            ‚¨áÔ∏è Descargar (.txt)
                        </button>
                    </div>
                    <p id="save-status" class="mt-2 text-sm text-center text-gray-600"></p>
                </div>
                <!-- FIN: Gesti√≥n de Archivos -->


                <div class="bg-white p-4 rounded-lg shadow-xl border border-gray-200">
                    <!-- TEXTO MODIFICADO AQU√ç -->
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Escribe tu Pseudoc√≥digo aqu√≠:
                    </label>
                    <!-- FIN TEXTO MODIFICADO -->
                    
                    <!-- ACE EDITOR VA EN ESTE DIV -->
                    <div id="editor-container" class="bg-gray-50"></div>
                </div>
                
                <!-- Controles y Entrada de Datos -->
                <div class="flex flex-col md:flex-row gap-4">
                    <button id="run-button" class="flex-grow px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 transition duration-150">
                        ‚ñ∂ Ejecutar y Simular
                    </button>
                    
                    <div class="flex-grow bg-white p-3 rounded-lg shadow border border-gray-200">
                        <label for="input-data" class="block text-sm font-medium text-gray-700 mb-1">
                            Entrada de Datos (separar por l√≠neas):
                        </label>
                        <textarea id="input-data" rows="3" class="w-full p-2 font-mono text-xs border border-gray-300 rounded focus:ring-teal-500 focus:border-teal-500" placeholder="5&#10;12"></textarea>
                    </div>
                </div>
            </div>

            <!-- Columna de Resultados (Consola y Variables) -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Consola de Salida -->
                <div class="bg-gray-800 text-white p-4 rounded-lg shadow-xl h-64 overflow-y-auto">
                    <h2 class="text-lg font-semibold mb-2 border-b border-gray-700 pb-1 text-teal-400">Consola de Salida</h2>
                    <pre id="output-console" class="console text-sm text-gray-200">
&gt; Listo para ejecutar.
                    </pre>
                </div>
                
                <!-- Inspector de Variables -->
                <div class="bg-white p-4 rounded-lg shadow-xl h-64 overflow-y-auto border border-gray-200">
                    <h2 class="text-lg font-semibold mb-2 border-b pb-1 text-teal-700">Variables</h2>
                    <div id="variables-inspector" class="text-sm font-mono space-y-1">
                        <!-- Las variables se mostrar√°n aqu√≠ -->
                        <p class="text-gray-500">No hay variables definidas.</p>
                    </div>
                </div>
                
                <!-- ID de Usuario para referencia -->
                <div class="bg-white p-3 rounded-lg shadow border border-gray-200">
                     <p class="text-xs text-gray-500">ID de Usuario (Necesario para Guardar): <span id="user-id-display" class="font-mono text-gray-800 break-all">Cargando...</span></p>
                </div>
            </div>

        </div>
    </div>

    <!-- ************************************************************ -->
    <!-- PARTE 1: DEFINICI√ìN DE ACE EDITOR (SIN MODULOS) -->
    <!-- ************************************************************ -->
    <script>
        // 1. Definici√≥n del Tokenizador (Tokenizer) para Pseudoc√≥digo Espa√±ol
        ace.define("ace/mode/pseudocode_highlight_rules", ["require", "exports", "module", "ace/lib/oop", "ace/mode/text_highlight_rules"], function(require, exports, module) {
            "use strict";
            var oop = require("../lib/oop");
            var TextHighlightRules = require("./text_highlight_rules").TextHighlightRules;
            
            var PseudocodeHighlightRules = function() {
                this.$rules = {
                    "start": [
                        // Comentarios de una l√≠nea (similar a //)
                        { token: "ace_comment", regex: "#.*$" },
                        
                        // Cadenas de texto
                        { token: "ace_string", regex: /['"](?:\.|[^'"])*['"]/ },
                        
                        // N√∫meros (enteros y reales)
                        { token: "ace_numeric", regex: "[+-]?\\d+(?:\\.\\d+)?" },
                        
                        // Palabras clave de E/S (Input/Output) -> Azul
                        { token: "ace_storage ace_type ace_io", regex: "\\b(Escribir|Leer|Mostrar)\\b" },
                        
                        // Palabras clave de Definici√≥n de Estructura -> Azul
                        { token: "ace_keyword ace_definition", regex: "\\b(Proceso|FinProceso|Definir|Como)\\b" },
                        
                        // Tipos de datos -> Amarillo/√Åmbar
                        { token: "ace_support ace_type", regex: "\\b(Entero|Real|Caracter|Logico|L√≥gico)\\b" },
                        
                        // Estructuras de Control (Condicionales y Ciclos) -> Azul
                        { token: "ace_keyword ace_control", regex: "\\b(Si|Entonces|Sino|FinSi|Mientras|Hacer|FinMientras|Para|Hasta|ConPaso|FinPara)\\b" },
                        
                        // Operadores y asignaci√≥n -> Azul
                        { token: "ace_keyword ace_operator", regex: "<-|[<>!=\\+\\-\\*\\/]|\\b(Y|O|NO)\\b" },
                        
                        // Palabras clave de valor (booleanos) -> Naranja
                        { token: "ace_constant ace_language", regex: "\\b(Verdadero|Falso)\\b" },
                    ]
                };
            };
            oop.inherits(PseudocodeHighlightRules, TextHighlightRules);
            exports.PseudocodeHighlightRules = PseudocodeHighlightRules;
        });

        // 2. Definici√≥n del Modo Completo (incluye el tokenizador)
        ace.define("ace/mode/pseudocode", ["require", "exports", "module", "ace/lib/oop", "ace/mode/text", "ace/mode/pseudocode_highlight_rules"], function(require, exports, module) {
            "use strict";
            var oop = require("../lib/oop");
            var TextMode = require("./text").Mode;
            var PseudocodeHighlightRules = require("./pseudocode_highlight_rules").PseudocodeHighlightRules;

            var Mode = function() {
                this.HighlightRules = PseudocodeHighlightRules;
            };
            oop.inherits(Mode, TextMode);

            (function() {
                this.lineCommentStart = "#"; // Definimos el comentario de l√≠nea
            }).call(Mode.prototype);

            exports.Mode = Mode;
        });

        // 3. Proveedor de Autocompletaci√≥n
        window.pseudocodeCompleter = {
            getCompletions: function(editor, session, pos, prefix, callback) {
                var keywords = [
                    "Proceso", "FinProceso", "Definir", "Como", 
                    "Entero", "Real", "Caracter", "Logico", "L√≥gico",
                    "Escribir", "Leer", "Mostrar",
                    "Si", "Entonces", "Sino", "FinSi", 
                    "Mientras", "Hacer", "FinMientras", 
                    "Para", "Hasta", "ConPaso", "FinPara"
                ];
                
                callback(null, keywords.map(function(keyword) {
                    return {
                        caption: keyword,
                        value: keyword,
                        meta: "Palabra Clave"
                    };
                }));
            }
        };
    </script>

    <!-- ************************************************************ -->
    <!-- PARTE 2: INICIALIZACI√ìN DE FIREBASE Y L√ìGICA PRINCIPAL (MODULAR) -->
    <!-- ************************************************************ -->
    <script type="module">
        // Importaciones de Firebase (Usando CDN para el entorno de un solo archivo HTML)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ************************************************************
        // --- CONFIGURACI√ìN DE FIREBASE Y API ---
        // ************************************************************
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Error parsing firebase config:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Configuraci√≥n de la API de Gemini
        // üîëüîëüîë L√çNEA CLAVE: ¬°PEGA TU API KEY AQU√ç DENTRO DE LAS COMILLAS! üîëüîëüîë
        const API_KEY = "AIzaSyAK0ezgHEiho0lRkHA4apu5oXYsUES5BiA"; 
        // üîëüîëüîë ¬°ASEG√öRATE DE REEMPLAZAR 'TU_CLAVE_AQUI' POR TU CLAVE REAL! üîëüîëüîë
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // --- INSTANCIAS DE FIREBASE ---
        let db;
        let auth;
        let userId = null;

        // --- Referencias DOM ---
        const editorContainer = document.getElementById('editor-container');
        const runButton = document.getElementById('run-button');
        const outputConsole = document.getElementById('output-console');
        const inputData = document.getElementById('input-data');
        const variablesInspector = document.getElementById('variables-inspector');
        const apiKeyWarning = document.getElementById('api-key-warning');
        
        // ELEMENTOS DE PERSISTENCIA
        const documentTitleInput = document.getElementById('document-title');
        const saveButton = document.getElementById('save-button');
        const loadButton = document.getElementById('load-button');
        const downloadButton = document.getElementById('download-button'); // NUEVO
        const saveStatus = document.getElementById('save-status');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- Ace Editor Instance ---
        let editor;

        // --- Estado de la Aplicaci√≥n ---
        let variables = {};
        let inputQueue = [];
        let executionCounter = 0;


        // ************************************************************
        // --- ACE EDITOR: INICIALIZACI√ìN ---
        // ************************************************************

        function initAceEditor() {
            // Inicializar la instancia de Ace Editor
            editor = ace.edit(editorContainer);
            editor.setTheme("ace/theme/tomorrow_night_eighties"); // Tema oscuro
            
            // DESACTIVAR el resaltado de l√≠nea al enfocar (CR√çTICO)
            editor.setHighlightActiveLine(false);

            // Configurar el modo de pseudoc√≥digo que se defini√≥ en el script anterior
            editor.session.setMode("ace/mode/pseudocode"); 
            
            // Configurar autocompletaci√≥n
            ace.require("ace/ext/language_tools");
            editor.setOptions({
                enableBasicAutocompletion: true,
                enableLiveAutocompletion: true,
                showPrintMargin: false
            });
            // Acceder al proveedor de autocompletaci√≥n definido en el script global
            editor.completers = [window.pseudocodeCompleter]; 
            
            // Re-implementar el bloqueo de pegado para Ace Editor
            editor.container.addEventListener('paste', handlePasteAttempt);

            // Establecer el c√≥digo inicial
            editor.setValue(
`Proceso CalculadoraSuma
  # Este es un comentario: ¬°ahora en verde y negrita!
  Definir num1, num2, suma Como Real
  
  Escribir "Ingrese el primer n√∫mero:"
  Leer num1
  
  Si num1 < 0 Entonces
    Escribir "El n√∫mero debe ser positivo."
    num1 <- num1 * -1
  FinSi
  
  Escribir "Ingrese el segundo n√∫mero:"
  Leer num2
  
  suma <- num1 + num2
  
  Escribir "La suma ajustada es: ", suma
FinProceso
`, -1); // -1 para colocar el cursor al inicio

            // Ajustar el foco al cargar
            editor.focus();
        }

        // ************************************************************
        // --- FUNCIONES DE SEGURIDAD Y UTILIDAD ---
        // ************************************************************

        /**
         * Maneja el intento de pegar c√≥digo para mantener la pol√≠tica educativa.
         */
        function handlePasteAttempt(event) {
            event.preventDefault(); 
            const consoleElement = document.getElementById('output-console');
            consoleElement.textContent = `
> üõë Operaci√≥n de pegado bloqueada. 
> Este entorno requiere que el c√≥digo sea escrito a mano para fines educativos.
> ¬°A codificar!`;
            consoleElement.classList.remove('text-gray-200');
            consoleElement.classList.add('text-yellow-400');
            
            setTimeout(() => {
                 consoleElement.classList.remove('text-yellow-400');
                 consoleElement.classList.add('text-gray-200');
                 if (consoleElement.textContent.includes("Operaci√≥n de pegado bloqueada")) {
                     consoleElement.textContent = "> Listo para ejecutar.";
                 }
            }, 3000);

            return false;
        }

        /**
         * 1. Limpia el estado de ejecuci√≥n anterior.
         */
        function initializeState() {
            variables = {};
            inputQueue = inputData.value.split('\n').map(s => s.trim()).filter(s => s.length > 0);
            executionCounter++;
            outputConsole.textContent = '';
            runButton.disabled = true;
            runButton.textContent = "‚öôÔ∏è Ejecutando...";
            updateVariablesDisplay();
        }

        /**
         * 2. Formatea el pseudoc√≥digo del usuario para que Gemini lo interprete.
         */
        function buildPrompt(code) {
            const systemPrompt = `Eres un int√©rprete de pseudoc√≥digo estricto. Tu tarea es analizar el c√≥digo de entrada, ejecutarlo y simular el resultado de la consola (Escribir) y el estado final de las variables.
            
            Sigue estas reglas estrictas:
            1. Procesa el c√≥digo l√≠nea por l√≠nea.
            2. Maneja las variables (Entero, Real, Caracter, L√≥gico). Si no se define el tipo, asume 'Real'.
            3. Para la instrucci√≥n 'Leer <variable>', consume el siguiente valor de la 'Input Queue'. En el 'consoleOutput', inmediatamente despu√©s del mensaje de 'Escribir' que solicita la entrada, **debes mostrar el valor consumido de la 'Input Queue' en su propia l√≠nea, simulando la entrada del usuario y el salto de l√≠nea (Enter)**. Si la queue est√° vac√≠a, genera un error.
            4. Para la instrucci√≥n 'Escribir <expresion>', genera la l√≠nea de salida.
            5. Maneja estructuras de control (Si-Entonces-Sino, Mientras, Para).
            6. La salida debe ser una cadena JSON en el formato EXCLUSIVO.

            --- FORMATO DE SALIDA REQUERIDO ---
            {
              "consoleOutput": "texto de la consola l√≠nea por l√≠nea",
              "finalVariables": [
                { "name": "variable1", "value": "valor final" },
                { "name": "variable2", "value": "valor final" }
                // ... otros objetos variable
              ],
              "error": "Mensaje de error si la ejecuci√≥n fall√≥ (vac√≠o si no hay error)"
            }
            
            Ejecuta el siguiente c√≥digo de pseudoc√≥digo.`;

            const userQuery = `
            --- CONTEXTO DE ENTRADA ---
            Input Queue (Entrada para 'Leer'): [${inputQueue.join(', ')}]
            C√≥digo a ejecutar:
            ${code}
            `;
            
            return { systemPrompt, userQuery };
        }
        
        /**
         * 3. Muestra la salida y el estado final de las variables.
         */
        function displayResults(data) {
            try {
                outputConsole.textContent = data.consoleOutput || "Ejecuci√≥n finalizada sin salida a la consola.";
                
                variables = (data.finalVariables || []).reduce((acc, current) => {
                    if (current.name) {
                        acc[current.name] = current.value;
                    }
                    return acc;
                }, {});

                updateVariablesDisplay();

                if (data.error) {
                    outputConsole.textContent += `\n\n--- ERROR DE EJECUCI√ìN ---\n${data.error}`;
                    outputConsole.classList.remove('text-gray-200');
                    outputConsole.classList.add('text-red-400');
                } else {
                    outputConsole.classList.remove('text-red-400');
                    outputConsole.classList.add('text-gray-200');
                }

            } catch (e) {
                console.error("Error al procesar la respuesta del modelo:", e);
                outputConsole.textContent = `Error interno: No se pudo procesar el resultado de la ejecuci√≥n.`;
                outputConsole.classList.add('text-red-400');
            }
        }
        
        /**
         * 4. Actualiza el panel de variables.
         */
        function updateVariablesDisplay() {
            variablesInspector.innerHTML = '';
            const varNames = Object.keys(variables);
            
            if (varNames.length === 0) {
                variablesInspector.innerHTML = '<p class="text-gray-500">No hay variables definidas.</p>';
                return;
            }

            for (const name in variables) {
                const value = variables[name];
                const varElement = document.createElement('p');
                varElement.className = 'flex justify-between items-center py-1 border-b border-gray-100 last:border-b-0';
                varElement.innerHTML = `
                    <span class="text-teal-600 font-semibold">${name}</span>
                    <span class="text-gray-900">${value}</span>
                `;
                variablesInspector.appendChild(varElement);
            }
        }

        /**
         * 5. Llama a la API de Gemini para la simulaci√≥n de ejecuci√≥n.
         */
        async function runCode() {
            if (API_KEY === "TU_CLAVE_AQUI" || API_KEY === "") {
                outputConsole.textContent = "> ERROR: Por favor, inserta tu clave de API de Gemini.";
                return;
            }

            const code = editor.getValue(); // USANDO ACE EDITOR
            if (code.trim() === '') {
                outputConsole.textContent = '> Por favor, escribe un c√≥digo para ejecutar.';
                return;
            }
            
            initializeState();

            const { systemPrompt, userQuery } = buildPrompt(code);

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "consoleOutput": { "type": "STRING", description: "Texto de la consola l√≠nea por l√≠nea." },
                            "finalVariables": { 
                                "type": "ARRAY", 
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "name": { "type": "STRING", description: "El nombre de la variable." },
                                        "value": { "type": "STRING", description: "El valor final de la variable (ej. 5, 'hola', true)." }
                                    },
                                    "required": ["name", "value"]
                                },
                                description: "Lista de objetos, donde cada objeto contiene el nombre y el valor final de una variable."
                            },
                            "error": { "type": "STRING", description: "Mensaje de error de ejecuci√≥n. Cadena vac√≠a si la ejecuci√≥n fue exitosa." }
                        }
                    }
                }
            };
            
            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        let errorMessage = `HTTP error! status: ${response.status}.`;
                        const errorBody = await response.json();
                        if (errorBody && errorBody.error && errorBody.error.message) {
                            errorMessage = `Server Rejected (Code: ${response.status}): ${errorBody.error.message}`;
                        }

                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    
                    const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (jsonText) {
                        const parsedData = JSON.parse(jsonText);
                        displayResults(parsedData);
                    } else {
                        const rawText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Respuesta vac√≠a del modelo.";
                        outputConsole.textContent = `ERROR: La respuesta del modelo no pudo ser procesada como JSON. Raw Output:\n${rawText}`;
                        outputConsole.classList.add('text-red-400');
                    }
                    break;
                } catch (error) {
                    console.error("Error en la llamada a la API:", error);
                    if (attempt === maxRetries - 1) {
                         const finalErrorMessage = error.message;
                         outputConsole.textContent = `‚ùå Fallo de comunicaci√≥n con el int√©rprete despu√©s de ${maxRetries} intentos.\nDetalle: ${finalErrorMessage}`;
                         outputConsole.classList.add('text-red-400');
                    }
                }
            }
            
            runButton.disabled = false;
            runButton.textContent = "‚ñ∂ Ejecutar y Simular";
        }

        // ************************************************************
        // --- FUNCIONES DE PERSISTENCIA (FIRESTORE) ---
        // ************************************************************

        /**
         * Guarda el pseudoc√≥digo actual en Firestore.
         */
        async function saveCode() {
            if (!userId) {
                saveStatus.textContent = "Error: La aplicaci√≥n no est√° autenticada. No se puede guardar.";
                saveStatus.classList.add('text-red-500');
                return;
            }
            const documentTitle = documentTitleInput.value.trim();
            if (!documentTitle) {
                saveStatus.textContent = "Error: El nombre del archivo no puede estar vac√≠o.";
                saveStatus.classList.add('text-red-500');
                return;
            }

            saveButton.disabled = true;
            loadButton.disabled = true;
            downloadButton.disabled = true;
            saveStatus.textContent = "Guardando...";
            saveStatus.classList.remove('text-red-500', 'text-blue-500');
            saveStatus.classList.add('text-gray-600');

            try {
                // Ruta de datos privada: /artifacts/{appId}/users/{userId}/pseudocode_files/{documentId}
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'pseudocode_files', documentTitle);
                await setDoc(docRef, {
                    code: editor.getValue(), // USANDO ACE EDITOR
                    timestamp: new Date().toISOString()
                });
                
                saveStatus.textContent = `‚úÖ C√≥digo guardado como '${documentTitle}' con √©xito.`;
                saveStatus.classList.remove('text-gray-600');
                saveStatus.classList.add('text-blue-500');

            } catch (error) {
                console.error("Error al guardar el c√≥digo:", error);
                saveStatus.textContent = `‚ùå Error al guardar: ${error.message}`;
                saveStatus.classList.remove('text-gray-600');
                saveStatus.classList.add('text-red-500');
            } finally {
                saveButton.disabled = false;
                loadButton.disabled = false;
                downloadButton.disabled = false;
                setTimeout(() => saveStatus.textContent = '', 5000);
            }
        }

        /**
         * Carga el pseudoc√≥digo desde Firestore.
         */
        async function loadCode() {
            if (!userId) {
                saveStatus.textContent = "Error: La aplicaci√≥n no est√° autenticada. No se puede cargar.";
                saveStatus.classList.add('text-red-500');
                return;
            }
            const documentTitle = documentTitleInput.value.trim();
            if (!documentTitle) {
                saveStatus.textContent = "Error: El nombre del archivo no puede estar vac√≠o.";
                saveStatus.classList.add('text-red-500');
                return;
            }

            saveButton.disabled = true;
            loadButton.disabled = true;
            downloadButton.disabled = true;
            saveStatus.textContent = "Cargando...";
            saveStatus.classList.remove('text-red-500', 'text-blue-500');
            saveStatus.classList.add('text-gray-600');

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'pseudocode_files', documentTitle);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    editor.setValue(data.code || '', -1); // USANDO ACE EDITOR
                    saveStatus.textContent = `‚úÖ C√≥digo cargado como '${documentTitle}' con √©xito.`;
                    saveStatus.classList.remove('text-gray-600');
                    saveStatus.classList.add('text-blue-500');
                } else {
                    saveStatus.textContent = `‚ö†Ô∏è No se encontr√≥ el archivo con el nombre '${documentTitle}'.`;
                    saveStatus.classList.remove('text-gray-600');
                    saveStatus.classList.add('text-red-500');
                }
            } catch (error) {
                console.error("Error al cargar el c√≥digo:", error);
                saveStatus.textContent = `‚ùå Error al cargar: ${error.message}`;
                saveStatus.classList.remove('text-gray-600');
                saveStatus.classList.add('text-red-500');
            } finally {
                saveButton.disabled = false;
                loadButton.disabled = false;
                downloadButton.disabled = false;
                setTimeout(() => saveStatus.textContent = '', 5000);
            }
        }

        /**
         * Descarga el c√≥digo actual del editor como un archivo .txt.
         */
        function downloadCodeAsTxt() {
            const codeContent = editor.getValue();
            let filename = documentTitleInput.value.trim() || 'pseudocodigo_sin_titulo';
            
            // Asegurarse de que el nombre de archivo termine en .txt
            if (!filename.toLowerCase().endsWith('.txt')) {
                filename += '.txt';
            }

            // Crear un Blob (objeto binario) con el contenido y el tipo de archivo (texto plano)
            const blob = new Blob([codeContent], { type: 'text/plain' });
            
            // Crear un enlace temporal para el navegador
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename; // Nombre del archivo que se descargar√°
            
            // Simular un clic para iniciar la descarga
            document.body.appendChild(a);
            a.click();
            
            // Limpiar el objeto URL temporal
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);

            saveStatus.textContent = `‚¨áÔ∏è Archivo '${filename}' descargado con √©xito.`;
            saveStatus.classList.remove('text-red-500', 'text-blue-500');
            saveStatus.classList.add('text-purple-500');
            setTimeout(() => saveStatus.textContent = '', 5000);
        }

        // ************************************************************
        // --- INICIALIZACI√ìN Y EVENTOS ---
        // ************************************************************

        /**
         * Inicializa Firebase y autentica al usuario.
         */
        async function initFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                 // Si no hay configuraci√≥n de Firebase
                console.warn("Configuraci√≥n de Firebase no disponible.");
                saveStatus.textContent = "El almacenamiento de c√≥digo no est√° disponible (Falta configuraci√≥n de Firebase).";
                return;
            }

            try {
                // Configuraci√≥n de Logging para depuraci√≥n
                setLogLevel('error'); 
                
                // 1. Inicializar app y servicios
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 2. Autenticar usando el token proporcionado o de forma an√≥nima
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Establecer el listener de estado de autenticaci√≥n
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        saveButton.disabled = false;
                        loadButton.disabled = false;
                        saveStatus.textContent = "Servicio de Guardado listo.";
                    } else {
                        userId = null;
                        userIdDisplay.textContent = "Desconectado";
                        saveButton.disabled = true;
                        loadButton.disabled = true;
                        saveStatus.textContent = "Error de autenticaci√≥n. No se puede guardar.";
                    }
                });

            } catch (error) {
                console.error("Error de inicializaci√≥n de Firebase/Autenticaci√≥n:", error);
                userIdDisplay.textContent = `Error: ${error.message}`;
                saveStatus.textContent = `Error cr√≠tico en Firebase: ${error.message}`;
                saveButton.disabled = true;
                loadButton.disabled = true;
            }
        }

        // --- Event Listeners ---
        runButton.addEventListener('click', runCode);
        saveButton.addEventListener('click', saveCode);
        loadButton.addEventListener('click', loadCode);
        downloadButton.addEventListener('click', downloadCodeAsTxt); // ASIGNACI√ìN DEL NUEVO BOT√ìN
        
        // --- Inicializaci√≥n Principal ---
        window.onload = () => {
             // 1. Inicializar Ace Editor
            initAceEditor();

            // 2. Verificar la API Key de Gemini
            if (API_KEY === "TU_CLAVE_AQUI" || API_KEY === "") {
                apiKeyWarning.classList.remove('hidden');
                runButton.disabled = true;
                runButton.textContent = "Clave API Faltante";
                outputConsole.textContent = "> üî¥ ERROR: Por favor, inserta tu clave de API de Gemini para ejecutar el int√©rprete.";
            } else {
                 apiKeyWarning.classList.add('hidden');
                 runButton.disabled = false;
                 outputConsole.textContent = "‚úÖ Clave de API detectada. ¬°Listo para ejecutar!";
            }
            
            // 3. Inicializar Firebase para guardar y cargar
            initFirebase();
        };

    </script>
</body>
</html>