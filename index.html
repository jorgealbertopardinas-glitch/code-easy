<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CodeEasy - Intérprete de Pseudocódigo</title>
<script src="https://www.google.com/search?q=https://cdn.tailwindcss.com"></script>
<link href="https://www.google.com/search?q=https://fonts.googleapis.com/css2%3Ffamily%3DInter:wght%40400%3B600%3B700%26family%3DFira%2BCode:wght%40400%3B500%3B600%26display%3Dswap" rel="stylesheet">
<style>
:root {
--primary: #4f46e5; /* Indigo 600 /
--primary-dark: #4338ca; / Indigo 700 /
--background: #f8fafc; / Slate 50 /
--surface: #ffffff; / White /
}
body {
font-family: 'Inter', sans-serif;
background-color: var(--background);
line-height: 1.6;
}
.code-font {
font-family: 'Fira Code', monospace;
}
.container-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 24px;
}
@media (max-width: 768px) {
.container-grid {
grid-template-columns: 1fr;
gap: 16px;
}
}
textarea {
resize: none;
transition: border-color 0.2s;
}
.scrollable {
overflow-y: auto;
}
/ Custom Scrollbar for better code visualization /
.scrollable::-webkit-scrollbar {
width: 8px;
}
.scrollable::-webkit-scrollbar-thumb {
background-color: #cbd5e1; / Slate 300 /
border-radius: 4px;
}
.scrollable::-webkit-scrollbar-track {
background: #f1f5f9; / Slate 100 /
}
/ Focus styles for textarea */
textarea:focus {
outline: none;
border-color: var(--primary-dark);
}
</style>
</head>
<body class="p-4 md:p-8">

<div id="app" class="max-w-7xl mx-auto">

    <!-- Header -->
    <header class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-indigo-600" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.55.895l-3.239 1.62a1 1 0 00-.5.894v2.585a1 1 0 01-.55.895l-1.92 1.28A1 1 0 009 15v3a1 1 0 01-2 0v-3a1 1 0 00-.55-.895l-1.92-1.28A1 1 0 014 9.485V6.894a1 1 0 00-.5-.894L.55 6a1 1 0 01-.55-.895V3zM4 6.894V9.485a3 3 0 001.65 2.684l2.5 1.667V11.2a1 1 0 01.55-.895l3.239-1.62A3 3 0 0015 6.894V3H4v3.894z" clip-rule="evenodd" />
            </svg>
            CodeEasy
        </h1>
        <p class="text-gray-500 mt-1">Intérprete de Pseudocódigo (Español)</p>
    </header>

    <!-- Main Grid Container -->
    <div class="container-grid">
        
        <!-- Code Editor (Left Side) -->
        <div class="bg-white shadow-lg rounded-xl overflow-hidden flex flex-col h-[50vh] md:h-[60vh] border border-gray-200">
            <div class="bg-gray-100 p-3 flex justify-between items-center border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700">Editor de Código</h2>
                <div class="space-x-2">
                    <button id="runButton" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md flex items-center disabled:opacity-50" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        Ejecutar
                    </button>
                </div>
            </div>
            <!-- Textarea for Code Input -->
            <textarea id="codeInput" placeholder="Escribe tu pseudocódigo aquí (Ej: Escribir 'Hola Mundo')..." 
                class="code-font p-4 flex-grow border-0 outline-none text-gray-800 text-sm scrollable"
                spellcheck="false"></textarea>
        </div>

        <!-- Console and Variables (Right Side) -->
        <div class="flex flex-col space-y-4">
            
            <!-- Console Output -->
            <div class="bg-gray-800 shadow-lg rounded-xl overflow-hidden flex flex-col h-1/2 min-h-[150px] border border-gray-700">
                <div class="bg-gray-700 p-3 flex justify-between items-center border-b border-gray-600">
                    <h2 class="text-lg font-semibold text-white">Consola de Salida</h2>
                    <button id="clearConsoleButton" class="text-sm text-gray-300 px-3 py-1 border border-gray-500 rounded-lg hover:bg-gray-600 transition duration-150 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        Limpiar
                    </button>
                </div>
                <!-- Console Text Area -->
                <pre id="consoleOutput" class="code-font p-4 flex-grow text-white text-xs scrollable bg-gray-900/90"></pre>
            </div>

            <!-- Variables Table -->
            <div class="bg-white shadow-lg rounded-xl overflow-hidden flex flex-col h-1/2 min-h-[150px] border border-gray-200">
                <div class="bg-gray-100 p-3 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-700">Variables Declaradas</h2>
                </div>
                <div class="flex-grow p-4 scrollable">
                    <table id="variablesTable" class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Nombre</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Valor</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- Filas de variables se insertarán aquí por JS -->
                        </tbody>
                    </table>
                    <p id="noVariablesMessage" class="text-sm text-gray-500 mt-2 italic text-center">No hay variables declaradas.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer and Instructions -->
    <footer class="mt-10 p-4 bg-white rounded-xl shadow-lg border border-gray-200">
        <h3 class="text-xl font-bold text-indigo-700 mb-3">Sintaxis Soportada</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-700">
            <div>
                <p class="font-semibold mb-1">Estructuras Básicas</p>
                <ul class="list-disc list-inside space-y-1 code-font">
                    <li>`Proceso` / `FinProceso`</li>
                    <li>`Definir variable Como Tipo` (Entero, Real, Caracter, Logico)</li>
                    <li>`Leer variable`</li>
                    <li>`Escribir "texto", variable`</li>
                </ul>
            </div>
            <div>
                <p class="font-semibold mb-1">Control de Flujo</p>
                <ul class="list-disc list-inside space-y-1 code-font">
                    <li>`Si condicion Entonces ... FinSi`</li>
                    <li>`Si condicion Entonces ... Sino ... FinSi`</li>
                    <li>`Mientras condicion Hacer ... FinMientras`</li>
                    <li>`Para variable Desde inicio Hasta fin Con Paso N Hacer ... FinPara`</li>
                </ul>
            </div>
            <div>
                <p class="font-semibold mb-1">Operadores</p>
                <ul class="list-disc list-inside space-y-1 code-font">
                    <li>Aritméticos: `+`, `-`, `*`, `/`, `^`, `%`</li>
                    <li>Relacionales: `=`, `!=`, `<`, `>`, `<=`, `>=`</li>
                    <li>Lógicos: `Y`, `O`, `No`</li>
                </ul>
            </div>
        </div>
    </footer>

</div>

<!-- Custom Modal for Input/Alerts (Replaces alert() and prompt()) -->
<div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
        <h3 id="modalTitle" class="text-xl font-semibold mb-4 text-gray-800">Título</h3>
        <p id="modalMessage" class="mb-4 text-gray-700"></p>
        <input type="text" id="modalInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 hidden" placeholder="Introduce tu valor aquí">
        <div id="modalButtons" class="mt-4 flex justify-end space-x-3">
            <!-- Buttons are inserted here by JS -->
        </div>
    </div>
</div>

<!-- JavaScript Interpreter Logic -->
<script>
    const codeInput = document.getElementById('codeInput');
    const runButton = document.getElementById('runButton');
    const consoleOutput = document.getElementById('consoleOutput');
    const clearConsoleButton = document.getElementById('clearConsoleButton');
    const variablesTableBody = document.querySelector('#variablesTable tbody');
    const noVariablesMessage = document.getElementById('noVariablesMessage');

    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalInput = document.getElementById('modalInput');
    const modalButtons = document.getElementById('modalButtons');

    let programState = {
        codeLines: [],
        currentLine: 0,
        variables: new Map(),
        isWaitingForInput: false,
        inputResolve: null
    };

    // --- Utility Functions ---

    /** Shows the custom modal for output, alerts, or input. */
    function showModal(title, message, isInput = false, onConfirm = null, onCancel = null) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalInput.value = '';
        modalInput.classList.toggle('hidden', !isInput);
        modalButtons.innerHTML = '';

        const confirmButton = document.createElement('button');
        confirmButton.className = 'px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150';

        if (isInput) {
            confirmButton.textContent = 'Aceptar';
            confirmButton.onclick = () => {
                modalOverlay.classList.add('hidden');
                if (onConfirm) onConfirm(modalInput.value);
            };
            
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancelar';
            cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150';
            cancelButton.onclick = () => {
                modalOverlay.classList.add('hidden');
                if (onCancel) onCancel();
            };
            modalButtons.appendChild(cancelButton);
            modalButtons.appendChild(confirmButton);

        } else {
            confirmButton.textContent = 'Cerrar';
            confirmButton.onclick = () => modalOverlay.classList.add('hidden');
            modalButtons.appendChild(confirmButton);
        }

        modalOverlay.classList.remove('hidden');
        if (isInput) modalInput.focus();
    }

    /** Appends text to the console output. */
    function log(message, type = 'output') {
        const span = document.createElement('span');
        span.classList.add('block', 'whitespace-pre-wrap');
        
        if (type === 'error') {
            span.classList.add('text-red-400', 'font-bold');
        } else if (type === 'input') {
            span.classList.add('text-yellow-400');
        } else {
            span.classList.add('text-gray-200');
        }
        
        span.textContent = message;
        consoleOutput.appendChild(span);
        consoleOutput.scrollTop = consoleOutput.scrollHeight; // Auto-scroll
    }
    
    /** Clears the console and resets state. */
    clearConsoleButton.addEventListener('click', () => {
        consoleOutput.textContent = '';
        updateVariablesDisplay(new Map()); // Clear variables display
        programState.variables.clear(); // Clear internal variables
    });

    /** Updates the variables table in the UI. */
    function updateVariablesDisplay(variables) {
        variablesTableBody.innerHTML = '';
        if (variables.size === 0) {
            noVariablesMessage.classList.remove('hidden');
            return;
        }
        noVariablesMessage.classList.add('hidden');

        variables.forEach((data, name) => {
            const row = variablesTableBody.insertRow();
            row.className = 'hover:bg-indigo-50 transition duration-100';

            // Format value for display (e.g., wrap strings in quotes)
            let displayValue = data.value;
            if (data.type === 'Caracter' && typeof data.value === 'string') {
                displayValue = `"${data.value}"`;
            } else if (data.type === 'Logico') {
                displayValue = data.value ? 'Verdadero' : 'Falso';
            } else if (data.type === 'Real') {
                // Ensure Real numbers show enough precision
                displayValue = Number(data.value).toFixed(2);
            }

            // Name Cell
            let cell = row.insertCell();
            cell.textContent = name;
            cell.className = 'px-3 py-2 code-font font-medium text-gray-900';

            // Type Cell
            cell = row.insertCell();
            cell.textContent = data.type;
            cell.className = 'px-3 py-2 text-gray-500';

            // Value Cell
            cell = row.insertCell();
            cell.textContent = displayValue;
            cell.className = 'px-3 py-2 code-font text-indigo-600 font-semibold';
        });
    }

    // --- Core Interpreter Logic ---

    /** Tokenizes a line of code into command and arguments. */
    function tokenize(line) {
        line = line.trim();
        if (!line) return null;

        // Simple handling for assignments (first = is the assignment operator)
        const assignmentMatch = line.match(/^([a-zA-Z_][a-zA-Z0-9_]*)\s*<-\s*(.*)$/);
        if (assignmentMatch) {
            return { command: 'Asignacion', args: [assignmentMatch[1].trim(), assignmentMatch[2].trim()] };
        }

        // Look for commands like Escribir, Leer, Definir, Si, etc.
        const parts = line.split(/\s+/);
        const command = parts[0].toLowerCase();
        const rest = line.substring(parts[0].length).trim();

        if (command === 'definir') {
            const match = rest.match(/^([a-zA-Z_][a-zA-Z0-9_]*)\s+como\s+(entero|real|caracter|logico)$/i);
            if (match) return { command: 'Definir', args: [match[1], match[2]] };
        } else if (command === 'escribir') {
            return { command: 'Escribir', args: [rest] };
        } else if (command === 'leer') {
            return { command: 'Leer', args: [rest] };
        } else if (command === 'si') {
            const match = rest.match(/^(.*)\s+entonces$/i);
            if (match) return { command: 'Si', args: [match[1]] };
        } else if (command === 'sino') {
            return { command: 'Sino', args: [] };
        } else if (command === 'finsi') {
            return { command: 'FinSi', args: [] };
        } else if (command === 'mientras') {
            const match = rest.match(/^(.*)\s+hacer$/i);
            if (match) return { command: 'Mientras', args: [match[1]] };
        } else if (command === 'finmientras') {
            return { command: 'FinMientras', args: [] };
        } else if (command === 'para') {
            const match = rest.match(/^([a-zA-Z_][a-zA-Z0-9_]*)\s+desde\s+(.*)\s+hasta\s+(.*)(?:\s+con\s+paso\s+(.*))?\s+hacer$/i);
            if (match) return { command: 'Para', args: [match[1], match[2], match[3], match[4] || '1'] };
        } else if (command === 'finpara') {
            return { command: 'FinPara', args: [] };
        } else if (command === 'proceso' || command === 'finproceso') {
            return { command: parts[0], args: [] };
        }

        // Fallback for simple commands or unrecognized lines
        return { command: parts[0], args: [rest] };
    }

    /** Evaluates a mathematical or logical expression. */
    function evaluateExpression(expression, variables) {
        expression = expression.trim();
        if (!expression) throw new Error("Expresión vacía.");

        // 1. Replace Logical operators (Y, O, No) with JS equivalents (&&, ||, !)
        expression = expression.replace(/ Y /gi, ' && ')
                               .replace(/ O /gi, ' || ')
                               .replace(/ No /gi, ' !');

        // 2. Replace Pseudocode operators (<=, >=, <>, =, ^, %)
        expression = expression.replace(/ != /g, ' !== ')
                               .replace(/ = /g, ' === ') // Use strict equality for comparison
                               .replace(/ <- /g, ' = '); // Should be handled by Asignacion, but good for safety

        // 3. Replace variable names with their values
        variables.forEach((data, name) => {
            const value = data.value;
            const type = data.type;
            
            // Use regex word boundary to prevent partial replacement (e.g., 'a' in 'var')
            const regex = new RegExp(`\\b${name}\\b`, 'g');
            
            if (type === 'Caracter') {
                // Strings must be quoted in the JS expression
                expression = expression.replace(regex, JSON.stringify(value));
            } else if (type === 'Logico') {
                // Logicos map to true/false in JS
                expression = expression.replace(regex, value ? 'true' : 'false');
            } else {
                // Numeric or other types
                expression = expression.replace(regex, value);
            }
        });

        // 4. Handle String literals (must be quoted)
        expression = expression.replace(/"([^"]*)"/g, (match, p1) => `'${p1}'`);

        // 5. Custom replacement for Exponentiation (^) and Modulo (%) which are `Math.pow` and `%`
        // NOTE: This complex step is often simplified in real interpreters. For simplicity here, we rely on standard JS operators, assuming no complex ^ usage outside simple arithmetic.

        try {
            // Use a wrapper function to execute the expression safely
            const result = new Function(`return ${expression};`)();
            return result;
        } catch (e) {
            throw new Error(`Error de evaluación de expresión: ${e.message} en "${expression}"`);
        }
    }

    /** Tries to convert a value to a specific type. */
    function convertToType(value, type) {
        type = type.toLowerCase();
        if (type === 'entero') {
            const num = parseInt(value);
            if (isNaN(num)) throw new Error(`El valor "${value}" no es un Entero válido.`);
            return num;
        } else if (type === 'real') {
            const num = parseFloat(value);
            if (isNaN(num)) throw new Error(`El valor "${value}" no es un Real válido.`);
            return num;
        } else if (type === 'caracter') {
            // PSeInt treats "string" as a "character type"
            return String(value);
        } else if (type === 'logico') {
            const str = String(value).toLowerCase();
            if (str === 'verdadero' || str === 'true') return true;
            if (str === 'falso' || str === 'false') return false;
            throw new Error(`El valor "${value}" no es un Lógico válido.`);
        }
        return value;
    }
    
    // --- Execution Loop and Control ---

    /** Finds the matching block end (e.g., FinSi for Si). */
    function findBlockEnd(startLine, lines, startCommand, endCommand) {
        let depth = 0;
        for (let i = startLine + 1; i < lines.length; i++) {
            const token = tokenize(lines[i]);
            if (!token) continue;

            if (token.command.toLowerCase() === startCommand.toLowerCase()) {
                depth++;
            } else if (token.command.toLowerCase() === endCommand.toLowerCase()) {
                if (depth === 0) return i;
                depth--;
            } else if (startCommand.toLowerCase() === 'si' && token.command.toLowerCase() === 'sino' && depth === 0) {
                // Special case for Si-Sino-FinSi: Sino acts as a temporary end
                return i;
            }
        }
        throw new Error(`Error: Falta ${endCommand} para el bloque ${startCommand} que comienza en la línea ${startLine + 1}.`);
    }

    /** Executes the program asynchronously to handle input. */
    async function runProgram() {
        if (programState.isWaitingForInput) return; // Prevent re-running during input

        const code = codeInput.value;
        // Clean code: remove comments and trim
        programState.codeLines = code.split('\n')
            .map(line => line.split('//')[0].trim())
            .filter(line => line.length > 0);

        // Reset state
        programState.currentLine = 0;
        programState.variables.clear();
        consoleOutput.textContent = '';
        updateVariablesDisplay(programState.variables);
        
        log('--- INICIO DE EJECUCIÓN ---', 'info');
        
        let stack = []; // For control flow (Si, Mientras, Para)

        // Find Proceso block
        let start = programState.codeLines.findIndex(line => line.toLowerCase().startsWith('proceso'));
        let end = programState.codeLines.findIndex(line => line.toLowerCase().startsWith('finproceso'));
        
        if (start === -1 || end === -1 || start > end) {
            log('Error: La estructura "Proceso ... FinProceso" es obligatoria.', 'error');
            return;
        }

        programState.currentLine = start + 1;

        try {
            // Main execution loop
            while (programState.currentLine < end && programState.currentLine < programState.codeLines.length) {
                const line = programState.codeLines[programState.currentLine];
                const token = tokenize(line);
                
                if (!token) {
                    programState.currentLine++;
                    continue;
                }
                
                const cmd = token.command.toLowerCase();
                const args = token.args;

                // Execute command based on token
                if (cmd === 'definir') {
                    const [name, type] = args;
                    if (programState.variables.has(name)) {
                        throw new Error(`Variable "${name}" ya ha sido definida.`);
                    }
                    // Default value based on type (0 for num, "" for char, false for logico)
                    let defaultValue = null;
                    if (type.toLowerCase() === 'entero' || type.toLowerCase() === 'real') defaultValue = 0;
                    if (type.toLowerCase() === 'caracter') defaultValue = "";
                    if (type.toLowerCase() === 'logico') defaultValue = false;

                    programState.variables.set(name, { type, value: defaultValue });
                    programState.currentLine++;

                } else if (cmd === 'asignacion') {
                    const [name, expression] = args;
                    const variableData = programState.variables.get(name);

                    if (!variableData) {
                        throw new Error(`Variable "${name}" no definida. Use "Definir ${name} Como Tipo".`);
                    }
                    
                    const result = evaluateExpression(expression, programState.variables);
                    
                    // Type conversion/checking
                    variableData.value = convertToType(result, variableData.type);

                    updateVariablesDisplay(programState.variables);
                    programState.currentLine++;

                } else if (cmd === 'escribir') {
                    let output = '';
                    // Simple argument parsing: split by commas outside quotes
                    const parts = args[0].match(/(?:[^\s,"]+|"[^"]*")+/g) || [];

                    for (const part of parts) {
                        if (part.startsWith('"') && part.endsWith('"')) {
                            // String literal
                            output += part.substring(1, part.length - 1);
                        } else {
                            // Variable or Expression
                            try {
                                const value = evaluateExpression(part, programState.variables);
                                if (typeof value === 'boolean') {
                                    output += value ? 'Verdadero' : 'Falso';
                                } else {
                                    output += value;
                                }
                            } catch (e) {
                                output += part; // If evaluation fails, print as text
                            }
                        }
                    }
                    log(output);
                    programState.currentLine++;

                } else if (cmd === 'leer') {
                    const name = args[0].trim();
                    const variableData = programState.variables.get(name);

                    if (!variableData) {
                        throw new Error(`Variable "${name}" no definida para la operación Leer.`);
                    }

                    programState.isWaitingForInput = true;
                    runButton.disabled = true;
                    
                    // Asynchronously wait for input from the custom modal
                    await new Promise(resolve => {
                        programState.inputResolve = resolve;
                        showModal(
                            'Entrada de Usuario', 
                            `Ingrese un valor para la variable '${name}' (Tipo: ${variableData.type}):`, 
                            true, 
                            (inputValue) => {
                                try {
                                    // Attempt to convert input value to the required type
                                    variableData.value = convertToType(inputValue, variableData.type);
                                    updateVariablesDisplay(programState.variables);
                                    log(`> ${inputValue}`, 'input'); // Log user input
                                    programState.currentLine++;
                                    resolve(); // Continue execution
                                } catch (e) {
                                    showModal('Error de Tipo', e.message);
                                    resolve(); // Resolve to prevent freezing, error will be logged in console
                                    throw e; // Re-throw the error to stop the execution loop
                                }
                            }
                        );
                    });

                    // Execution continues after the modal is handled
                    programState.isWaitingForInput = false;
                    runButton.disabled = false;
                    programState.inputResolve = null;

                } else if (cmd === 'si') {
                    const condition = evaluateExpression(args[0], programState.variables);
                    const endIf = findBlockEnd(programState.currentLine, programState.codeLines, 'Si', 'FinSi');
                    const sino = findBlockEnd(programState.currentLine, programState.codeLines, 'Si', 'Sino');
                    
                    if (condition) {
                        // Condition is true: enter the Si block
                        stack.push({ type: 'Si', jump: endIf });
                        programState.currentLine++; // Move into the Si block
                    } else {
                        // Condition is false: jump to Sino (if present) or FinSi (if not)
                        const jumpTarget = (sino !== -1 && sino < endIf) ? sino + 1 : endIf + 1;
                        programState.currentLine = jumpTarget;
                    }

                } else if (cmd === 'sino') {
                    // Sino command: must jump to FinSi
                    const endIf = findBlockEnd(programState.currentLine, programState.codeLines, 'FinSi', 'FinSi'); // Simple way to find the next FinSi
                    programState.currentLine = endIf + 1;

                } else if (cmd === 'finsi') {
                    // FinSi command: pop the Si block from the stack if it was active
                    // NOTE: If using the stack for proper block exiting, we'd pop here. 
                    // For a simple interpreter, just continue.
                    programState.currentLine++;

                } else if (cmd === 'mientras') {
                    const condition = args[0];
                    const startWhile = programState.currentLine;

                    if (evaluateExpression(condition, programState.variables)) {
                        // Condition is true: enter the loop
                        stack.push({ type: 'Mientras', start: startWhile, condition });
                        programState.currentLine++;
                    } else {
                        // Condition is false: jump past FinMientras
                        const endWhile = findBlockEnd(startWhile, programState.codeLines, 'Mientras', 'FinMientras');
                        programState.currentLine = endWhile + 1;
                    }

                } else if (cmd === 'finmientras') {
                    const whileBlock = stack.findLast(s => s.type === 'Mientras');
                    if (!whileBlock) throw new Error("Error de sintaxis: 'FinMientras' sin 'Mientras' correspondiente.");
                    
                    if (evaluateExpression(whileBlock.condition, programState.variables)) {
                        // Condition is still true: loop back
                        programState.currentLine = whileBlock.start + 1; 
                    } else {
                        // Condition is false: exit the loop, move past FinMientras, and remove from stack
                        stack.pop();
                        programState.currentLine++;
                    }
                
                } else if (cmd === 'para') {
                    // NOTE: 'Para' implementation is complex due to its one-line nature (initialization, condition, increment)
                    // This simple interpreter skips the 'Para' block and just moves to the next line.
                    // For a functional 'Para' loop, a much more complex state tracking mechanism is required.
                    log(`ADVERTENCIA: La sintaxis 'Para' se reconoce pero no se interpreta completamente en este simulador.`, 'error');
                    programState.currentLine++;
                } 
                
                else {
                    // Unrecognized or complex command (e.g., Funciones)
                    log(`ADVERTENCIA: Comando no reconocido o ignorado: "${line}"`, 'error');
                    programState.currentLine++;
                }

            }
        } catch (e) {
            log(`ERROR de EJECUCIÓN en línea ${programState.currentLine + 1}: ${e.message}`, 'error');
        }

        log('--- FIN DE EJECUCIÓN ---', 'info');
        programState.isWaitingForInput = false;
        runButton.disabled = false;
    }

    // --- Event Listeners and Initial State ---
    
    // Initial setup for the code input area
    const initialCode = 


`Proceso Ejemplo
// Define una variable entera
Definir edad Como Entero;

Escribir "Hola! Por favor, dime tu edad:";
Leer edad;

Si edad >= 18 Entonces
    Escribir "Eres mayor de edad.";
Sino
    Escribir "Eres menor de edad.";
FinSi

// Un bucle Mientras
Definir contador Como Entero;
contador <- 1;
Mientras contador <= 3 Hacer
    Escribir "Contador:", contador;
    contador <- contador + 1;
FinMientras


FinProceso`;

    codeInput.value = initialCode;

    // Enable/disable run button based on content
    codeInput.addEventListener('input', () => {
        runButton.disabled = codeInput.value.trim().length === 0 || programState.isWaitingForInput;
    });
    // Check initial state
    runButton.disabled = codeInput.value.trim().length === 0;

    runButton.addEventListener('click', () => {
        runProgram();
    });

</script>


</body>
</html>
